<style>
	#container {
		height: 100%;
		display: flex;
		flex-direction: column;
	}

	#inputs {
		background: #f8f8f8;
		padding: 10px;
	}

	#progress-bar[value="1"] {
		display: none;
	}

	#progress-bar:not([value="1"]) ~ #uncached-fetch-button {
		display: none;
	}

	.input-row:not(:last-child) {
		margin-bottom: 3px;
	}

	.search-input-row {
		display: flex;
	}

	#search-input {
		flex: 1;
		margin-right: 15px;
	}

	#outputs {
		margin-top: 15px;
		overflow: auto;
	}

	.hidden {
		display: none !important;
	}

	.output-item, .output-category {
		margin-top: 5px;
	}

	.title {
		background: #eee;
		font-weight: bold;
	}

	.output-item-title {
		background: #afa;
		font-size: x-large;
	}

	.output-affixes {
		display: flex;
	}

	.output-affix {
		flex: 1;
	}

	.output-group {
		display: block;
		margin-right: 15px;
	}

	.output-group-toggle-mods-checkbox {
		display: none;
	}

	.output-group-toggle-mods-checkbox:not(:checked) ~ .output-mod {
		display: none;
	}

	.output-group-summary {
		display: flex;
	}

	.output-group-summary-field-group {
		display: none;
	}

	.output-group-summary-field-text {
		flex: 1;
	}

	.output-group-summary-field-weight {
		flex-basis: 40px;
		text-align: end;
	}

	.output-mod {
		display: flex;
		padding-left: 15px;
		background: #eee;
	}

	.output-mod-field-name {
		display: none;
	}

	.output-mod-field-text {
		flex: 1;
	}

	.output-mod-field-weight {
		flex-basis: 40px;
		text-align: end;
	}

</style>

<script>
	require('../arevtur/xElements/import');
</script>

<div id="container">
	<div id="inputs">
		<div>
			<progress id="progress-bar" max="1"></progress>
			<span id="fetch-time"></span>
			<button id="uncached-fetch-button">Uncached refresh</button>
		</div>
		<div class="input-row">
			<x-autocomplete-input id="item-input" placeholder="Item"></x-autocomplete-input>
			<input id="item-level-input" type="number" min="0" max="100" placeholder="Level">
		</div>
		<div class="input-row">
			<x-multi-select-lined id="category-input" placeholder="Categories"></x-multi-select-lined>
		</div>
		<div class="input-row">
			<x-multi-select-lined id="tag-input" placeholder="Tags"></x-multi-select-lined>
		</div>
		<div class="input-row search-input-row">
			<input id="search-input" placeholder="Search">
			<button id="clear-search-button">X</button>
		</div>
	</div>
	<div id="outputs"></div>
</div>

<script>
	const {XElement} = require('xx-element');
	const Searcher = require('../arevtur/Searcher');
	const {getModsByItem} = require('./modsDataFetcher');
	const $ = document.querySelector.bind(document);
	const $c = (tagName, parent = null, classList = [], text = '') => {
		let el = document.createElement(tagName);
		if (parent)
			parent.appendChild(el);
		el.classList.add(...classList);
		if (text)
			el.textContent = text;
		return el;
	};
	let setElOwner = (el, owner) => {
		owner.getVisible = () => !el.classList.contains('hidden');
		owner.setVisible = visible => el.classList.toggle('hidden', !visible);
	};
	const clone = obj => {
		if (Array.isArray(obj))
			return obj.map(v => clone(v));
		if (typeof obj === 'object' && obj)
			return Object.fromEntries(Object.entries(obj).map(([k, v]) => [k, clone(v)]))
		return obj;
	};

	let refreshData = async (uncached = false) => {
		let {modsByItem, fetchTime, progressStream} = getModsByItem(uncached);

		$('#progress-bar').value = 0;
		progressStream.forEach(progress => $('#progress-bar').value = progress);
		progressStream.promise.then(() => $('#progress-bar').value = 1);

		modsByItem = await modsByItem;
		window.modsByItem = modsByItem;
		$('#item-input').autocompletes = modsByItem.map(modsForItem => modsForItem.item);
		$('#category-input').autocompletes = modsByItem
			.flatMap(modsForItem =>
				modsForItem.modsByCategory.map(modsForCategory => modsForCategory.category))
			.filter((v, i, a) => a.indexOf(v) === i);
		$('#tag-input').autocompletes = modsByItem
			.flatMap(modsForItem =>
				modsForItem.modsByCategory.flatMap(modsForCategory =>
					modsForCategory.modsByGroup.flatMap(modsForGroup => modsForGroup.mods[0].tags)))
			.filter((v, i, a) => a.indexOf(v) === i);

		$('#item-input').addEventListener('change', () => filterOutput(modsByItem));
		$('#item-level-input').addEventListener('input', () => filterOutput(modsByItem));
		$('#category-input').addEventListener('change', () => filterOutput(modsByItem));
		$('#tag-input').addEventListener('change', () => filterOutput(modsByItem));
		$('#search-input').addEventListener('input', () => filterOutput(modsByItem));
		$('#clear-search-button').addEventListener('click', () => {
			$('#search-input').value = '';
			filterOutput(modsByItem);
		});

		generateOutput(modsByItem);
	};

	let generateOutput = modsByItem => {
		XElement.clearChildren($('#outputs'));
		modsByItem.forEach(modForItem => {
			let itemDiv = $c('div', $('#outputs'), ['output-item']);
			setElOwner(itemDiv, modForItem);
			$c('div', itemDiv, ['title', 'output-item-title'], modForItem.item);
			modForItem.modsByCategory.forEach(modForCategory => {
				let categoryDiv = $c('div', itemDiv, ['output-category']);
				setElOwner(categoryDiv, modForCategory);
				$c('div', categoryDiv, ['title', 'output-category-title'], modForCategory.category);
				let affixesModsDiv = $c('div', categoryDiv, ['output-affixes']);
				let prefixModsDiv = $c('div', affixesModsDiv, ['output-affix']);
				$c('div', prefixModsDiv, ['title', 'output-affixes-title'], 'Prefixes');
				let suffixModsDiv = $c('div', affixesModsDiv, ['output-affix']);
				$c('div', suffixModsDiv, ['title', 'output-affixes-title'], 'Suffixes');
				modForCategory.modsByGroup.forEach(modsForGroup => {
					let groupLabel = $c('label', modsForGroup.suffix ? suffixModsDiv : prefixModsDiv, ['output-group']);
					setElOwner(groupLabel, modsForGroup);
					let groupToggleModsCheckbox = $c('input', groupLabel, ['output-group-toggle-mods-checkbox']);
					groupToggleModsCheckbox.type = 'checkbox';
					let groupSummaryDiv = $c('div', groupLabel, ['output-group-summary']);
					$c('span', groupSummaryDiv, ['output-group-summary-field-group'], modsForGroup.group);
					$c('span', groupSummaryDiv, ['output-group-summary-field-text'],
						modsForGroup.mods[modsForGroup.mods.length - 1].text);
					$c('span', groupSummaryDiv, ['output-group-summary-field-tags'], `[${modsForGroup.tags.join(', ')}]`);
					$c('span', groupSummaryDiv, ['output-group-summary-field-weight'], modsForGroup.weight);
					modsForGroup.mods.forEach(mod => {
						let modDiv = $c('div', groupLabel, ['output-mod']);
						setElOwner(modDiv, mod);
						$c('span', modDiv, ['output-mod-field-name'], mod.name);
						$c('span', modDiv, ['output-mod-field-text'], mod.text);
						$c('span', modDiv, ['output-mod-field-level-requirement'], mod.levelRequirement);
						$c('span', modDiv, ['output-mod-field-weight'], mod.weight);
					});
				});
			});
		});
	};

	let filterOutput = modsByItem => {
		let item = $('#item-input').value;
		let categories = $('#category-input').values;
		let tags = $('#tag-input').values;
		let itemLevel = $('#item-level-input').value;
		let searcher = $('#search-input').value && new Searcher($('#search-input').value, false);

		modsByItem.forEach(modsForItem =>
			modsForItem.setVisible(!item || modsForItem.item === item));

		modsByItem.forEach(modsForItem =>
			modsForItem.modsByCategory.forEach(modsForCategory =>
				modsForCategory.setVisible(!categories.length || categories.includes(modsForCategory.category))));

		modsByItem.forEach(modsForItem =>
			modsForItem.modsByCategory.forEach(modsForCategory =>
				modsForCategory.modsByGroup.forEach(modsForGroup =>
					modsForGroup.setVisible(!tags.length || modsForGroup.tags.some(tag => tags.includes(tag))))));

		modsByItem.forEach(modsForItem =>
			modsForItem.modsByCategory.forEach(modsForCategory =>
				modsForCategory.modsByGroup.forEach(modsForGroup =>
					modsForGroup.mods.forEach(mod =>
						mod.setVisible(
							(!itemLevel || mod.levelRequirement <= itemLevel) &&
							(!searcher || searcher.test([mod.group, mod.text, ...mod.tags, mod.name])))))));

		modsByItem.forEach(modsForItem =>
			modsForItem.modsByCategory.forEach(modsForCategory =>
				modsForCategory.modsByGroup.forEach(modsForGroup =>
					modsForGroup.setVisible(modsForGroup.getVisible() && modsForGroup.mods.some(mod => mod.getVisible())))));

		modsByItem.forEach(modsForItem =>
			modsForItem.modsByCategory.forEach(modsForCategory =>
				modsForCategory.setVisible(modsForCategory.getVisible() && modsForCategory.modsByGroup.some(modsForGroup => modsForGroup.getVisible()))));

		modsByItem.forEach(modsForItem =>
			modsForItem.setVisible(modsForItem.getVisible() && modsForItem.modsByCategory.some(modsForCategory => modsForCategory.getVisible())));
	};

	$('#uncached-fetch-button').addEventListener('click', () => refreshData(true));
	refreshData();

	// todo display performance
	// todo some mod groups contain mods with multipel tags (e.g. "AilmentChanceAndDuration" on jewels)
	// todo weight %'s
	// todo display fetch time
	// todo multi-select not working when type then click

</script>
